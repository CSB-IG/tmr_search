#########################################################################################
################################## M  A  R  I  N  a #####################################
#########################################################################################

######## LOADS ########

setwd("~/MARINa")
library(ssmarina)
library(mixtools)
load("general_MARINa.RData")
to_clean <- ls()
print("Source and data set loaded")


########  R E G U L O N ######## 
### One proces by TF list

# adj from ARACNe imput data
TFDB_adjfile <- file.path("/home/hachepunto/MARINa/AnimalTFDB_p1e-10.adj")
print("adj loaded")


# Regulon generation
print("proced to compute the regulon")

TFDB_regulon <- aracne2regulon(TFDB_adjfile, dset)


print("regulon computed")

########  M A R I N A ######## 
print("proced to estimate the Master Regulators")
TFDB_mrs <- marina(signature, TFDB_regulon, nullmodel)

# Leading-edge analysis
TFDB_mrs <- ledge(TFDB_mrs)

print("Master Regulators estimated")

print(summary(TFDB_mrs))

TFDB_top_100 <-summary(TFDB_mrs,mrs=100)
write.table(TFDB_top_100,file = "TFDB_top_100mrs.txt",quote = FALSE, sep = "\t")

print("Top 100 Master Regulators saved in 'hugo_top_100mrs.txt' file")

########  B O O T S T R A P E D   M A R I N A ######## 

print("proced to compute the  bootstraped master regulators")
TFDB_BT_mrs <- marina(BTsignature, TFDB_regulon, nullmodel)

TFDB_BT_mrs <- bootstrapMarina(TFDB_BT_mrs, "mode")

print("master regulators bootstraped computed")

print(summary(TFDB_BT_mrs))

TFDB_BT_top_100 <-summary(TFDB_BT_mrs,mrs=100)
write.table(TFDB_BT_top_100,file = "TFDB_BT_top_100mrs.txt",quote = FALSE, sep = "\t")

print("Top 100 bootstraped Master Regulators saved in 'TFDB_BT_top_100mrs.txt' file")

#######Â  S H A D O W and S Y N E R G Y A N A L Y S I S #########
print("proced to compute the Shadow and Synergy analysis")

print("proced to compute the Shadow analysis")
# Shadow analysis
TFDB_mrshadow <- shadow(TFDB_mrs, pval=25)
# Bootstraped Shadow analysis
TFDB_mrshadow_BT <- shadow(TFDB_BT_mrs, pval=25)

print("Shadow analysis done")


print("proced to compute the Synergy analysis")

# Synergy analysis
TFDB_mrs <- marinaCombinatorial(TFDB_mrs, regulators=25) 

# Bootstraped Synergy analysis
TFDB_BT_mrs <- marinaCombinatorial(TFDB_BT_mrs, regulators=25) 
print("Synergy analysis done")



##################################################
#################### S A V E  ######################
##################################################
print("proced to Save")
rm(list=to_clean,to_clean) #cleaning
save.image("TFDB_MARINa.RData")
savehistory("TFDB_MARINa.Rhistory")

print("All done!")
